name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Docker container with Ngrok tunnel
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Fer checkout del codi
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Llan√ßar els contenidors amb Docker Compose (plugin integrat)
      - name: Run Docker containers
        run: docker compose up -d

      # 3Ô∏è‚É£ Llan√ßar t√∫nel ngrok
      - name: Start Ngrok Tunnel
        id: ngrok
        uses: luisboto/ngrok-tunnel-action@v0.1.7.2
        with:
          timeout: 10m           # Temps que vols que la web estigui accessible
          port: 8080             # Port exposat pel teu contenidor web
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          tunnel_type: http
          save_url_to_filename: tunnelURL.md

      # 4Ô∏è‚É£ Esperar uns segons que ngrok arranqui
      - name: Wait for Ngrok
        run: sleep 5

      # 5Ô∏è‚É£ Mostrar la URL p√∫blica als logs i al resum del workflow
      - name: Show public URL
        run: |
          URL=$(cat tunnelURL.md)
          echo "üåê Web accessible durant 10 minuts a: $URL"
          echo "::notice title=URL p√∫blica::$URL"

      # 6Ô∏è‚É£ Mantindre el contenidor actiu fins que acabi el timeout
      - name: Keep containers alive
        run: sleep 600   # Ha de coincidir amb timeout de 10 minuts
