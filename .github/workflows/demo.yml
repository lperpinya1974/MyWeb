name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Docker container with Ngrok tunnel
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositori
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Llan√ßar els contenidors amb Docker Compose
      - name: Run Docker containers
        run: docker-compose up -d

      # 3Ô∏è‚É£ Crear el t√∫nel amb Ngrok
      - name: Start Ngrok Tunnel
        id: ngrok
        uses: luisboto/ngrok-tunnel-action@v0.1.7.2
        with:
          timeout: 10m               # Durada de la demo
          port: 8080                 # Port del contenidor web
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          tunnel_type: http
          save_url_to_filename: tunnelURL.md

      # 4Ô∏è‚É£ Mostrar la URL p√∫blica als logs
      - name: Show public URL
        run: |
          URL=$(cat tunnelURL.md)
          echo "üåê Web accessible durant 10 minuts a: $URL"
          echo "::notice title=URL p√∫blica::$URL"

      # 5Ô∏è‚É£ Mantenir el contenidor actiu fins que acabi el t√∫nel
      - name: Keep containers alive
        run: sleep 600   # 10 minuts (ha de coincidir amb el timeout de ngrok)
