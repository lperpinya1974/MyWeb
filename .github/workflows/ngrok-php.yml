name: Apache + PHP + Ngrok v3 Demo

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del codi
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instal¬∑lar Apache i PHP
      - name: Install Apache and PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2 php libapache2-mod-php
          sudo systemctl enable apache2

      # 3Ô∏è‚É£ Configurar Apache DocumentRoot al repo i permisos correctes amb grup compartit
      - name: Configure Apache DocumentRoot and group permissions
        run: |
          # Afegir l'usuari del runner al grup www-data
          sudo usermod -a -G www-data $USER

          # Canviar propietari de tot el workspace al grup www-data
          sudo chgrp -R www-data $GITHUB_WORKSPACE

          # Permisos: 775 directoris, 664 fitxers
          sudo find $GITHUB_WORKSPACE -type d -exec chmod 775 {} \;
          sudo find $GITHUB_WORKSPACE -type f -exec chmod 664 {} \;

          # Configurar DocumentRoot a $GITHUB_WORKSPACE
          sudo sed -i 's|/var/www/html|'"$GITHUB_WORKSPACE"'|g' /etc/apache2/sites-available/000-default.conf

          # Assegurar que Apache permet acc√©s a tot el DocumentRoot
          sudo sed -i '/<Directory /s|</Directory>|    Require all granted\n</Directory>|' /etc/apache2/sites-available/000-default.conf

          sudo systemctl restart apache2

      # 4Ô∏è‚É£ Instal¬∑lar Ngrok v3 fora de $GITHUB_WORKSPACE
      - name: Install Ngrok v3
        run: |
          curl -sLo /tmp/ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
          unzip -o /tmp/ngrok.zip -d /tmp
          sudo mv /tmp/ngrok /usr/local/bin/
          sudo chmod +x /usr/local/bin/ngrok
          /usr/local/bin/ngrok version

      # 5Ô∏è‚É£ Autenticar Ngrok amb el secret
      - name: Authenticate Ngrok
        run: /usr/local/bin/ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      # 6Ô∏è‚É£ Llan√ßar el t√∫nel ngrok i capturar la URL p√∫blica
      - name: Start Ngrok tunnel
        id: ngrok
        run: |
          /usr/local/bin/ngrok http 80 --log=stdout > ngrok.log &
          NGROK_PID=$!

          TIMEOUT=30
          ELAPSED=0
          NGROK_URL=""
          while [ -z "$NGROK_URL" ] && [ $ELAPSED -lt $TIMEOUT ]; do
            sleep 1
            NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels 2>/dev/null | \
                         grep -oP '"public_url":"\Khttps://[^"]+')
            ELAPSED=$((ELAPSED+1))
          done

          if [ -z "$NGROK_URL" ]; then
            echo "‚ùå No s'ha pogut obtenir la URL p√∫blica de Ngrok."
            kill $NGROK_PID
            exit 1
          fi

          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "üåê Web accessible a: $NGROK_URL"
          echo "::notice title=URL p√∫blica::$NGROK_URL"

          # Mant√© el t√∫nel actiu durant 10 minuts
          sleep 600
          kill $NGROK_PID

      # 7Ô∏è‚É£ Neteja Apache al final (opcional)
      - name: Stop Apache
        if: always()
        run: sudo systemctl stop apache2
